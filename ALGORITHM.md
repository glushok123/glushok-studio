# Алгоритм работы Glushok Studio

Документ описывает полный цикл обработки, который выполняет приложение Glushok Studio.

## 1. Подготовка пользовательского интерфейса
* При запуске `GlushokStudio.py` загружает форму `gui/index.ui` и настраивает элементы управления (`MainApp.__init__`).
* Значения параметров обработки считываются из элементов интерфейса при старте обработки (`setParamsUi`).
* Вкладка «Очередь» отображает список папок, выбранных пользователем. Кнопки «Добавить папку»/«Удалить папку» управляют очередью. Кнопка «Выполнить» запускает пакетную обработку (`startQueueProcessing`).

## 2. Формирование очереди заданий
* При выборе каталогов (`addFolderToQueue`) программа рекурсивно анализирует содержимое и добавляет в очередь только те папки, которые содержат изображения допустимых форматов (`checkFolderContent`).
* Для каждого элемента очереди хранится путь, статус и процент выполнения. Отображение статусов синхронизировано с `QListWidget` (`updateFolderStatus`).

## 3. Запуск пакетной обработки
* Метод `startQueueProcessing` проверяет наличие задач и инициализирует обработку первой папки, затем `processNextFolder` поочередно запускает фоновый поток `ThreadStart` для каждой папки.
* Во время обработки отображается анимация прогресса, обновляется лог и статус текущего задания.

## 4. Обработка в рабочем потоке (`ThreadStart.process`)
Для каждой папки выполняется следующая последовательность операций (опции зависят от флажков в интерфейсе):
1. **Определение вложенных папок.** Собираются конечные директории с файлами, чтобы обработать каждую вложенную серию изображений отдельно.
2. **Удаление внешней рамки (опция «Удалять чёрную рамку»).**
   * `module/removeBorder.py`: для каждого изображения определяется область содержимого (`detect_content_bounds`) и выполняется обрезка с учётом порогов ширины/высоты и необязательного отступа (`crop_to_content`).
   * Результаты сохраняются в промежуточный каталог `<имя>(до разделения на страницы)`.
3. **Разделение разворотов (опция «Делить изображение пополам»).**
   * `module/split_image/processing.py`: файлы анализируются и разделяются на страницы (`split_spread`).
   * При включённой опции ручной корректировки формируется список разворотов, требующих уточнения, и отображается диалог `ManualSplitDialog` для интерактивной правки.
4. **Дополнительное удаление рамки после разделения (комбинация «Удалять рамку» + «Добавлять чёрную рамку»).**
   * `module/removePostBorder.py`: повторно обрезает страницы, чтобы очистить добавленные поля перед финальным оформлением.
5. **Добавление рамки (опция «Добавлять чёрную рамку»).**
   * `module/addBorder.py`: вокруг каждого изображения добавляется равномерная рамка шириной `border_px`.
6. **Унификация разрешения (опция «Подстраивать разрешение»).**
   * При ручной корректировке сохранённые параметры высоты/ширины применяются к последующим изображениям (`trim_page_to_resolution`, `enforce_entry_targets`).
7. **Переименование файлов.**
   * `module/rename.py`: формирует нумерованные имена `<папка>_NNN.<расширение>` для сохранения порядка.
8. **Перенос итоговых файлов.**
   * Содержимое каталога результата перемещается в структуру, повторяющую последние уровни исходного пути, чтобы сохранить исходную иерархию.

## 5. Обновление интерфейса после обработки папки
* После завершения поток генерирует сигнал `end`, который переводит статус текущей папки в «Готово», обновляет прогресс до 100% и запускает обработку следующего элемента (`finishFolder`).
* В случае преждевременного завершения без вызова `finishFolder` статус обновляется на «Ошибка» (`checkThreadError`).

## 6. Просмотр результатов
* При активированных опциях предпросмотра исходные и итоговые изображения загружаются во вкладки «Изначальные сканы» и «Результат» (`showStartImage`, `showEndImage`).
* Выбор элемента в списке выводит изображение в правой панели (`Clicked`).

## 7. Завершение работы
* После обработки всей очереди выводится сообщение «Обработка очереди завершена» и статус обработки переключается в режим ожидания новых заданий.

Этот алгоритм описывает последовательность действий от выбора исходных папок до получения готовых изображений, включая взаимодействие с пользователем и внутренние стадии обработки.
